name: üöÄ Deploy RestaurantePOS

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    name: üèóÔ∏è Build & Deploy
    runs-on: self-hosted

    steps:
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4

      - name: üõë Detener contenedores anteriores
        run: docker-compose down --remove-orphans || true

      - name: üèóÔ∏è Construir y levantar contenedores
        run: docker-compose up -d --build --force-recreate

      - name: ‚è≥ Esperar que la DB est√© lista
        run: |
          echo "Esperando a PostgreSQL..."
          for i in $(seq 1 30); do
            if docker exec restaurante-db pg_isready -U postgres > /dev/null 2>&1; then
              echo "‚úÖ PostgreSQL est√° listo"
              break
            fi
            echo "Intento $i/30..."
            sleep 2
          done

      - name: ‚úÖ Verificar servicios
        run: |
          echo "=== Estado de contenedores ==="
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "=== Health Check API ==="
          sleep 3
          curl -sf http://localhost:3000/api/auth/me || echo "‚ö†Ô∏è API a√∫n iniciando (normal en primer deploy)"
          echo ""
          echo "=== Logs del backend ==="
          docker logs restaurante-api --tail 10

      - name: üßπ Limpiar im√°genes sin uso
        run: docker image prune -f || true
